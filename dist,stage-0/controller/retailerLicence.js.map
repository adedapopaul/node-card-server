{"version":3,"sources":["../../src/controller/retailerLicence.js"],"names":["randomize","require","nodemailer","transporter","createTransport","service","auth","user","pass","config","db","api","get","req","res","RetailerLicence","find","err","users","send","json","serial","params","console","log","put","body","username","imei","phoneSerial","message","ref","update","id","_id","findByIdAndUpdate","licenceKey","email","mailOptions","from","to","subject","html","sendMail","post","newLicence","save"],"mappings":";;;;;;AAAA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,IAAMA,YAAYC,QAAQ,YAAR,CAAlB;AACA,IAAMC,aAAaD,QAAQ,YAAR,CAAnB;;AAEA,IAAME,cAAcD,WAAWE,eAAX,CAA2B;AAC7CC,WAAS,OADoC;AAE7CC,QAAM;AACJC,UAAM,uBADF;AAEJC,UAAM;AAFF;AAFuC,CAA3B,CAApB;;kBAQc,gBAAoB;AAAA,MAAjBC,MAAiB,QAAjBA,MAAiB;AAAA,MAATC,EAAS,QAATA,EAAS;;AAChC,MAAIC,MAAM,sBAAV;;AAEA;AACAA,MAAIC,GAAJ,CAAQ,GAAR,EAAa,UAACC,GAAD,EAAMC,GAAN,EAAc;AACzBC,8BAAiBC,IAAjB,CAAsB,EAAtB,EAA0B,UAACC,GAAD,EAAMC,KAAN,EAAgB;AACxC,UAAID,GAAJ,EAAS;AACPH,YAAIK,IAAJ,CAASF,GAAT;AACD;AACDH,UAAIM,IAAJ,CAASF,KAAT;AACD,KALD;AAMD,GAPD;;AASA;AACAP,MAAIC,GAAJ,CAAQ,UAAR,EAAoB,UAACC,GAAD,EAAMC,GAAN,EAAc;AAChCC,8BAAiBC,IAAjB,CAAuB,EAACK,QAAQR,IAAIS,MAAJ,CAAWD,MAApB,EAAvB,EAAqD,UAACJ,GAAD,EAAMV,IAAN,EAAe;AAClE,UAAIU,GAAJ,EAAS;AACPM,gBAAQC,GAAR,CAAYP,GAAZ;AACD;AACDH,UAAIM,IAAJ,CAASb,IAAT;AACD,KALD;AAMD,GAPD;;AASA;AACAI,MAAIc,GAAJ,CAAQ,UAAR,EAAoB,UAACZ,GAAD,EAAMC,GAAN,EAAc;AAChCC,8BAAiBC,IAAjB,CAAsB,EAACK,QAAQR,IAAIa,IAAJ,CAASL,MAAlB,EAAtB,EAAkD,UAACJ,GAAD,EAAMV,IAAN,EAAe;AAC/D,UAAIU,GAAJ,EAAS;AACPM,gBAAQC,GAAR,CAAYP,GAAZ;AACD;AACDM,cAAQC,GAAR,CAAYjB,IAAZ,EAAkB,YAAlB;AACD,UAAG;;AAEA,YAAGA,KAAK,CAAL,EAAQoB,QAAR,KAAqBd,IAAIa,IAAJ,CAASC,QAAjC,EAA0C;AACtC,cAAIpB,KAAK,CAAL,EAAQqB,IAAR,KAAgBf,IAAIa,IAAJ,CAASE,IAAzB,IAAiCrB,KAAK,CAAL,EAAQsB,WAAR,KAAuBhB,IAAIa,IAAJ,CAASG,WAArE,EAAmF;AAClFf,gBAAIM,IAAJ,CAAS,EAAEU,SAAS,2CAAX,EAAT;AACA,WAFD,MAII;AACF;AACD,gBAAIC,MAAM/B,UAAU,GAAV,EAAe,EAAf,CAAV;;AAEC,gBAAIgC,SAAS;AACX,uBAAU,CADC;AAEX,6BAAgBnB,IAAIa,IAAJ,CAASG,WAFd;AAGX,4BAAeE,GAHJ;AAIX,sBAASlB,IAAIa,IAAJ,CAASE;AAJP,aAAb;;AAOA,gBAAIK,KAAK1B,KAAK,CAAL,EAAQ2B,GAAjB;AACAnB,sCAAiBoB,iBAAjB,CAAoCF,EAApC,EAAwCD,MAAxC,EAAiD,UAACf,GAAD,EAAMV,IAAN,EAAe;AAC9D,kBAAIU,GAAJ,EAAQ;AACNM,wBAAQC,GAAR,CAAYP,GAAZ;AACD;AACDM,sBAAQC,GAAR,CAAYjB,KAAK6B,UAAjB,EAA6B,cAA7B;AACC;AACC,kBAAIC,QAAQ9B,KAAK8B,KAAjB;AACA,kBAAIC,cAAc;AAChBC,sBAAM,gCADU;AAEhBC,oBAAIH,KAFY;AAGhBI,yBAAS,mCAHO;AAIhBC,sBAAM;AAJU,eAAlB;AAMAvC,0BAAYwC,QAAZ,CAAqBL,WAArB;AACD,qBAAOxB,IAAIM,IAAJ,CAAS,EAAEgB,iBAAcL,GAAhB,EAAT,CAAP;AACF,aAfD;AAgBD;AACJ,SAlCD,MAmCK;AAACjB,cAAIM,IAAJ,CAAS,EAACU,SAAS,qBAAV,EAAT;AAA2C;AAClD,OAtCF,CAsCE,OAAMb,GAAN,EAAU;AACTH,YAAIM,IAAJ,CAAS,EAACU,SAAS,qBAAV,EAAT;AACD;AACF,KA9CD;AA+CD,GAhDD;;AAmDF;AACEnB,MAAIiC,IAAJ,CAAS,MAAT,EAAiB,UAAC/B,GAAD,EAAMC,GAAN,EAAc;;AAEzB;AACA,QAAI+B,aAAa,IAAI9B,yBAAJ,EAAjB;AACA8B,eAAWlB,QAAX,GAAsBd,IAAIa,IAAJ,CAASC,QAA/B;AACAkB,eAAWxB,MAAX,GAAoBR,IAAIa,IAAJ,CAASL,MAA7B;AACAwB,eAAWR,KAAX,GAAmBxB,IAAIa,IAAJ,CAASW,KAA5B;;AAGAQ,eAAWC,IAAX,CAAgB,UAAS7B,GAAT,EAAcV,IAAd,EAAoB;AAClC,UAAIU,GAAJ,EAAS;AACPM,gBAAQC,GAAR,CAAYP,GAAZ;AACD;AACE;AACG,UAAIoB,QAAQxB,IAAIa,IAAJ,CAASW,KAArB;AACAd,cAAQC,GAAR,CAAYa,KAAZ;AACA,UAAIC,cAAc;AAChBC,cAAM,gCADU;AAEhBC,YAAIH,KAFY;AAGhBI,iBAAS,qCAHO;AAIhBC,cAAM;;AAGZ;AAPsB,OAAlB,CAQJvC,YAAYwC,QAAZ,CAAqBL,WAArB;AACAxB,UAAIM,IAAJ,CAAS,EAAEC,aAAWd,KAAKc,MAAlB,EAAT;AACH,KAjBD;AAmBH,GA5BH;AA6BA,SAAOV,GAAP;AACD,C","file":"retailerLicence.js","sourcesContent":["import mongoose from 'mongoose';\r\nimport { Router } from 'express';\r\nimport RetailerLicence from '../model/retailerLicence';\r\nimport bodyParser from 'body-parser';\r\nimport passport from 'passport';\r\n\r\nconst randomize = require('randomatic');\r\nconst nodemailer = require('nodemailer');\r\n\r\nconst transporter = nodemailer.createTransport({\r\n  service: 'gmail',\r\n  auth: {\r\n    user: 'adedapopaul@gmail.com',\r\n    pass: 'moronkeji'\r\n  }\r\n});\r\n\r\nexport default({ config, db }) => {\r\n  let api = Router();\r\n\r\n  // '/v1/user' - GET all users\r\n  api.get('/', (req, res) => {\r\n    RetailerLicence .find({}, (err, users) => {\r\n      if (err) {\r\n        res.send(err);\r\n      }\r\n      res.json(users);\r\n    });\r\n  });\r\n\r\n  // '/v1/licence/:serial' - GET a specific user \r\n  api.get('/:serial', (req, res) => {\r\n    RetailerLicence .find( {serial: req.params.serial} , (err, user) => {\r\n      if (err) {\r\n        console.log(err)\r\n      }\r\n      res.json(user);\r\n    });\r\n  });\r\n\r\n  // '/v1/licence' - POST - update a user  \r\n  api.put('/licence', (req, res) => {\r\n    RetailerLicence .find({serial: req.body.serial }, (err, user) => {\r\n      if (err) {\r\n        console.log(err)\r\n      }\r\n      console.log(user, 'first user')\r\n     try{ \r\n\r\n        if(user[0].username === req.body.username){\r\n            if( user[0].imei=== req.body.imei || user[0].phoneSerial ===req.body.phoneSerial  ){\r\n             res.json({ message: 'This serial number is for a single device'})\r\n            }\r\n\r\n            else{\r\n              //generate reference number\r\n             let ref = randomize('a', 20);\r\n\r\n              let update = {\r\n                \"count\" : 1,\r\n                \"phoneSerial\" : req.body.phoneSerial,\r\n                \"licenceKey\" : ref,\r\n                \"imei\" : req.body.imei,\r\n              }\r\n\r\n              let id = user[0]._id\r\n              RetailerLicence .findByIdAndUpdate( id, update,  (err, user) => {\r\n                if (err){\r\n                  console.log(err)\r\n                }\r\n                console.log(user.licenceKey, \" second user\")\r\n                 // send notification email to buyer\r\n                  let email = user.email\r\n                  var mailOptions = {\r\n                    from: 'noreplySale@jyqwinslimited.com',\r\n                    to: email,\r\n                    subject: 'Confirmation of Device Activation',\r\n                    html: '<h1>Hello </h1><p>This is to confirm the payment for your device activation. Thank you.</p><p>Contact us on +234 816 787 6460 for any enquiry.</p>'\r\n                  }\r\n                  transporter.sendMail(mailOptions)\r\n                 return res.json({ licenceKey:`${ref}` } );\r\n              });\r\n            }\r\n        }\r\n         else{res.json({message: 'User does not exist'})}\r\n      }catch(err){\r\n        res.json({message: 'User does not exist'})\r\n      }\r\n    });\r\n  });\r\n\r\n\r\n// '/v1/licence/add' - POST - add a serial \r\n  api.post('/add', (req, res) => {\r\n        \r\n        // create user profile\r\n        let newLicence = new RetailerLicence ();\r\n        newLicence.username = req.body.username;\r\n        newLicence.serial = req.body.serial;\r\n        newLicence.email = req.body.email;\r\n\r\n\r\n        newLicence.save(function(err, user) {\r\n          if (err) {\r\n            console.log(err)\r\n          }\r\n             // send notification email to buyer\r\n                let email = req.body.email;\r\n                console.log(email)\r\n                var mailOptions = {\r\n                  from: 'noreplySale@jyqwinslimited.com',\r\n                  to: email,\r\n                  subject: 'Here is your Licence Serial Number!',\r\n                  html: '<h3>Dear Valued Customer </h3><p>Thank you for getting in touch with us. We have received your request for a licence. One of our team will get in touch with you soon.</p><p>You can also Contact us on +234 816 787 6460 for any enquiry.</p><p> Many Thanks</p>'\r\n                }\r\n\r\n            // send mail with defined transport object\r\n            transporter.sendMail(mailOptions)\r\n            res.json({ serial: `${user.serial}`});\r\n        });\r\n\r\n    });\r\n  return api;\r\n}\r\n"]}